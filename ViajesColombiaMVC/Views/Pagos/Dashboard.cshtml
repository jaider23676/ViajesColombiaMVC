@model ViajesColombiaMVC.Models.ViewModels.AdminPagosViewModel

@{
    ViewData["Title"] = "Dashboard de Pagos";
}

<h2 class="mb-4">Panel de Control - Pagos</h2>

<div class="row g-4">

    <!-- Total Pagos -->
    <div class="col-md-3">
        <div class="card text-white bg-primary shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title">Total Pagos</h5>
                <h2>@Model.TotalPagos</h2>
            </div>
        </div>
    </div>

    <!-- Pagos Completados -->
    <div class="col-md-3">
        <div class="card text-white bg-success shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title">Completados</h5>
                <h2>@Model.PagosCompletados</h2>
            </div>
        </div>
    </div>

    <!-- Pagos Pendientes -->
    <div class="col-md-3">
        <div class="card text-white bg-warning shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title">Pendientes</h5>
                <h2>@Model.PagosPendientes</h2>
            </div>
        </div>
    </div>

    <!-- Pagos Fallidos -->
    <div class="col-md-3">
        <div class="card text-white bg-danger shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title">Fallidos</h5>
                <h2>@Model.PagosFallidos</h2>
            </div>
        </div>
    </div>
</div>

<hr class="my-4" />

<h4>Últimos Pagos Registrados</h4>

<table class="table table-striped table-hover align-middle mt-3">
    <thead class="table-dark">
        <tr>
            <th>Usuario</th>
            <th>Paquete</th>
            <th>Forma de Pago</th>
            <th>Monto</th>
            <th>Fecha</th>
            <th>Estado</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var pago in Model.UltimosPagos)
        {
            <tr>
                <td>@pago.Reserva?.Usuario?.Nombre ?? "<span class='text-danger'>Sin Usuario</span>"</td>
                <td>@pago.Reserva?.Paquete?.Nombre ?? "<span class='text-danger'>Paquete no asignado</span>"</td>
                <td>@pago.FormaPago?.Nombre ?? "<span class='text-danger'>Forma de pago no asignada</span>"</td>
                <td>@pago.Monto.ToString("C")</td>
                <td>@(pago.FechaPago != null ? pago.FechaPago.ToShortDateString() : "<span class='text-danger'>Fecha no definida</span>")</td>
                <td>
                    @switch (pago.Estado)
                    {
                        case "Pendiente":
                            <span class="badge bg-warning">Pendiente</span>
                            break;
                        case "Completado":
                            <span class="badge bg-success">Completado</span>
                            break;
                        case "Fallido":
                            <span class="badge bg-danger">Fallido</span>
                            break;
                        default:
                            <span class="badge bg-secondary">Desconocido</span>
                            break;
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

<hr class="my-4" />

<h4>Resumen Mensual de Pagos</h4>
<canvas id="pagosChart" height="100"></canvas>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const ctx = document.getElementById('pagosChart').getContext('2d');
        const pagosChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Meses)),
                datasets: [
                    {
                        label: 'Pagos Completados',
                        data: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Completados)),
                        backgroundColor: 'rgba(25, 135, 84, 0.7)'
                    },
                    {
                        label: 'Pagos Pendientes',
                        data: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Pendientes)),
                        backgroundColor: 'rgba(255, 193, 7, 0.7)'
                    },
                    {
                        label: 'Pagos Fallidos',
                        data: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Fallidos)),
                        backgroundColor: 'rgba(220, 53, 69, 0.7)'
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: 'Pagos Mensuales' }
                }
            }
        });
    </script>
}
